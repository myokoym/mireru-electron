# Mireru Electron - プロジェクト仕様書

## 概要
Mireruは、キーボード操作に特化したファイルエクスプローラーです。Ruby実装の[mireru](./reference/)をElectron + React + TypeScriptで再実装したものです。

## コンセプト
- **気軽に使えるexplorer**: ファイル管理を直感的で効率的に。vim風キーバインドによる高速ナビゲーション
- **VS Codeのような詳細表示**: 開発者に馴染みのあるUI/UXで、豊富なファイル情報とメタデータを提供

### 設計方針
**気軽さ（Accessibility）:**
- 起動が早く、軽量で応答性の高いUI
- コマンドライン引数による柔軟な起動
- 直感的なキーバインドと検索機能

**詳細性（Rich Information）:**
- VS Code風の白基調テーマとアイコン体系
- 3パネル構成（ファイルリスト・プレビュー・メタ情報）
- シンタックスハイライト、EXIF情報、権限表示

## 技術スタック
- **フレームワーク**: Electron + React 19 + TypeScript
- **ベース**: electron-react-boilerplate
- **UI**: VS Code風の白基調デザイン
- **シンタックスハイライト**: react-syntax-highlighter (GitHub風スタイル)
- **開発環境**: WSL2 (Linux)

## 機能仕様

### サポートファイル形式
- **画像**: `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`, `.webp`, `.svg`
- **テキスト**: `.txt`, `.md`, `.js`, `.jsx`, `.ts`, `.tsx`, `.json`, `.html`, `.css`, `.xml`, `.log`, `.py`, `.rb`, `.php`, `.java`, `.c`, `.cpp`, `.h`, `.sh`, `.yaml`, `.yml`
- **動画**: `.mp4`, `.avi`, `.mov`, `.webm`, `.mkv`, `.flv`
- **PDF**: `.pdf` (プレースホルダー表示)
- **バイナリ**: その他すべてのファイル（hexdump表示、20KB制限）

### キーバインド (Ruby実装準拠)

#### ナビゲーション
- `n` / `ArrowDown` - 次のファイル/ディレクトリ
- `p` / `ArrowUp` - 前のファイル/ディレクトリ
- `G` - 最後のアイテムに移動
- `Ctrl+g` - 最初のアイテムに移動

#### ファイル操作
- `Enter` / `e` - ディレクトリを開く、またはファイルをプレビュー
- `Space` - ファイルプレビュー
- `r` - 現在のファイルをリロード
- `Backspace` - 親ディレクトリに戻る
- `Home` - 起動時のディレクトリに移動

#### プレビューパネルスクロール (vim風)
- `h` - 左スクロール (17px)
- `j` - 下スクロール (17px)
- `k` - 上スクロール (17px)
- `l` - 右スクロール (17px)
- `H` - 大きく左スクロール (170px)
- `J` - 大きく下スクロール (170px)
- `K` - 大きく上スクロール (170px)
- `L` - 大きく右スクロール (170px)

#### 画像操作
- `+` / `=` - ズームイン (最大5倍)
- `-` - ズームアウト (最小0.1倍)
- `f` - ウィンドウにフィット
- `o` - オリジナルサイズ (1倍)

#### 検索機能
- `/` - 検索ボックスにフォーカス
- `Escape` - 検索ボックスからフォーカス外す（検索テキスト保持）
- `Shift+Escape` - 検索をクリアしてフォーカス外す
- `ArrowDown/Up` - 検索中に矢印キーでファイルリストにフォーカス移動

#### その他
- `Escape` - プレビューをクリア（検索フォーカス外時）

#### 予定キーバインド（未実装）
- `i` / `F1` - メタ情報サイドバーの表示/非表示切り替え

### ファイルプレビュー仕様

#### 画像ファイル
- base64エンコードで表示
- ズーム機能付き
- transform: scale()でリアルタイム拡大縮小

#### テキストファイル
- **シンタックスハイライト**: 20以上の言語対応
  - JavaScript, TypeScript, Python, Ruby, Java, C/C++, Go, Rust
  - HTML, CSS, JSON, YAML, Markdown, SQL など
- **テーマ**: GitHub風ライトテーマ (UI統一性のため)
- **機能**: 行番号表示、モノスペースフォント
- **表示領域**: 最大化設計
- **予定機能**: 文字コード表示、改行コード表示（ステータスバーまたはサイドバー）

#### 動画ファイル
- **最適化**: base64エンコード廃止、`file://` URL使用
- **機能**: HTML5 video要素、コントロール付き
- **エラーハンドリング**: 再生エラー時のフィードバック

#### バイナリファイル
- **hexdump**: Ruby実装準拠 (20KB制限)
- **フォーマット**: `offset  hex_bytes  |ascii|` 形式
- **スタイル**: モノスペースフォント、スクロール対応

#### PDFファイル
- プレースホルダーメッセージ表示
- 外部アプリケーションでの閲覧を推奨

## UI設計

### レイアウト
```
┌─────────────────────────────────────────────────────┐
│ Header (パスバー + コントロール)                        │
├─────────────┬───────────────────────┬───────────────┤
│ ファイルリスト │ プレビューパネル        │ メタ情報       │
│ (300px固定)  │ (可変幅)              │ サイドバー     │
│ 自動スクロール │                     │ (切り替え可能) │
│ 対応         │                     │               │
└─────────────┴───────────────────────┴───────────────┤
│ ステータスバー (動的カウント更新)                        │
└─────────────────────────────────────────────────────┘
```

### カラーテーマ
- **ベース**: 白基調 (VS Code Light風)
- **選択アイテム**: `#007acc` (VS Code青)
- **フォント**: システムフォント + Monaco/Menlo (コード用)

### アイコン
**ファイル・ディレクトリアイコン（SVG）:**
- 📁 ディレクトリ（青いフォルダー）
- 🖼️ 画像ファイル（緑色、画像プレビュー）
- 📄 テキストファイル（白地、テキスト線）
- 🎬 動画ファイル（赤色、再生ボタン）
- 📋 PDFファイル（赤地、PDFテキスト）
- 言語固有アイコン（JS黄、TS青、Python青、Ruby赤など）

**ナビゲーションアイコン（SVG）:**
- 🏠 ホームボタン（家型アイコン）- 起動時のディレクトリに戻る
- ⬆️ 上へボタン（上矢印アイコン）- 親ディレクトリへ移動

## アーキテクチャ

### ディレクトリ構成
```
src/
├── main/
│   ├── main.ts          # メインプロセス、IPC handlers
│   ├── preload.ts       # プリロードスクリプト、API公開
│   └── ...
└── renderer/
    ├── App.tsx          # メインコンポーネント
    ├── App.css          # スタイル定義
    └── ...
```

### IPC通信
- `get-directory-contents` - ディレクトリ内容取得
- `read-file` - ファイル内容読み込み
- `get-home-directory` - ホームディレクトリパス取得
- `get-initial-directory` - コマンドライン引数から初期ディレクトリ取得
- `get-parent-directory` - 親ディレクトリパス取得
- `copy-to-clipboard` - クリップボードへのテキストコピー

### 状態管理
```typescript
interface FileItem {
  name: string;
  path: string;
  isDirectory: boolean;
  isFile: boolean;
  size: number;
  modified: Date;
  extension: string;
}

interface FileResult {
  type: 'text' | 'image' | 'video' | 'pdf' | 'hex';
  content: string;
  size: number;
}
```

## 開発・運用

### 開発環境セットアップ
```bash
# 依存関係インストール
npm install

# 開発サーバー起動
npm start

# 引数付きで起動（開発環境）
npm start /path/to/directory

# プロセス終了
pkill -f "mireru-electron"

# 再起動
./restart.sh
```

### 本番ビルド・配布
```bash
# 実行可能ファイル作成
npm run package

# AppImage実行（各種引数例）
./release/build/Mireru-0.1.0.AppImage /path/to/directory  # 絶対パス
./release/build/Mireru-0.1.0.AppImage .                   # 現在のディレクトリ
./release/build/Mireru-0.1.0.AppImage ./src              # 相対パス
./release/build/Mireru-0.1.0.AppImage file.txt           # ファイル（親ディレクトリで起動）
./release/build/Mireru-0.1.0.AppImage                    # 引数なし（ホーム）
```

### 開発ワークフロー

#### 基本的な作業の進め方
1. **機能実装・修正**
   - コードを変更
   - 必要に応じてアプリを再起動してテスト
   - 動作確認完了

2. **コミット**
   - 機能追加時: `git add <files> && git commit -m "..."`
   - コミットのみの場合は再起動不要
   - git commit確認も不要（出力は自動表示）

3. **仕様書更新**
   - 新機能・変更点を `SPEC.md` に反映
   - キーバインド変更、機能追加、アーキテクチャ変更など
   - 特に以下のセクションを更新:
     - **機能仕様**: 新しいファイル形式、機能追加
     - **キーバインド**: キー割り当て変更
     - **UI設計**: レイアウト・デザイン変更
     - **アーキテクチャ**: 新しいコンポーネント、IPC通信
     - **今後の改善案**: 完了した項目を削除、新しいアイデア追加

4. **再起動が必要なタイミング**
   - コード変更後のテスト時
   - 新機能の動作確認時
   - レンダラープロセス変更は自動リロード、メインプロセス変更は手動再起動

#### コミットメッセージのガイドライン
- **機能追加**: "Add [機能名]"
- **修正**: "Fix [問題]" / "Update [対象] to [目的]"
- **最適化**: "Optimize [対象]"
- **仕様書更新**: "Update specification document"

#### 開発時の重要な指示事項
- **コミット時**: 関連ドキュメント（SPEC.md、TODO.md）を同時に更新
- **機能実装後**: 必ずrestart.shで再起動してテスト
- **引数変更**: 実際にAppImageビルドして動作確認
- **デバッグログ**: 本番ビルドで問題が起きそうな機能はログを残す
- **テスト**: 複雑なロジックは単体テストを作成（引数解析の例参照）
- **バージョン管理**: release/ディレクトリはビルド成果物、適切に.gitignore設定済み

#### 次期実装予定機能
- **ソート機能**: ファイル名、サイズ、更新日でのソート切り替え
- **フォルダサイズ**: 非同期での合計サイズ計算・表示
- **更新日表示**: ファイルリストに更新日時カラム追加
- **可変幅**: ファイルリストとプレビューパネルの境界をドラッグでリサイズ
- **メタ情報サイドバー**: 選択ファイルの詳細情報表示（サイズ、作成日、更新日、権限、EXIF等）
- **文字コード検出**: テキストファイルの文字エンコーディング自動判定・表示（UTF-8、Shift_JIS、EUC-JP、ASCII等）
  - 実装候補: chardet、encoding-japanese、jschardet
- **改行コード表示**: ファイルの改行形式検出・表示（LF、CRLF、CR）
  - バッファ解析による自動検出、ステータスバーまたはサイドバーに表示
- **文字数カウント**: テキストファイルの文字数・行数・バイト数を集計・表示
  - リアルタイム計算、メタ情報サイドバーまたはステータスバーに表示

#### プロセス管理のベストプラクティス
```bash
# 開発開始時
pkill -f "mireru-electron" && npm start &

# コード変更後（レンダラープロセスは自動リロード）
# メインプロセス変更時のみ手動再起動
pkill -f "mireru-electron" && npm start &

# 作業終了時
pkill -f "mireru-electron"
```

### ビルド
```bash
# 本番ビルド
npm run build

# パッケージング
npm run package
```

### テスト・デバッグ
- **単体テスト**: Jest + TypeScript (`npm test`)
- **引数解析テスト**: `src/__tests__/argument-parser.test.ts`
- **レンダラープロセス**: ホットリロード対応
- **メインプロセス**: electronmon による自動再起動
- **DevTools**: 開発環境で自動利用可能
- **デバッグログ**: 本番ビルドでの引数解析状況を追跡

## パフォーマンス最適化

### メモリ最適化
- **動画ファイル**: base64エンコード廃止、file:// URL使用
- **バイナリファイル**: 20KB制限でメモリ使用量制御
- **ファイル表示**: 遅延読み込み、必要時のみプレビュー

### バンドルサイズ最適化
- **シンタックスハイライト**: Lightコンポーネント使用
- **言語パック**: 必要な言語のみ個別インポート

## 今後の改善案

### 機能拡張
- [ ] PDF本格プレビュー対応
- [ ] 動画プレビューの一時停止機能 (space key)
- [ ] より多くのファイル形式対応
- [ ] ファイル検索機能
- [ ] ブックマーク機能

### UI/UX改善
- [ ] ダークテーマ対応
- [ ] ファイルリストの幅調整（ドラッグリサイズ）
- [ ] キーバインドのカスタマイズ
- [ ] 設定画面の追加
- [ ] ファイル・フォルダソート機能（名前、サイズ、更新日）
- [ ] フォルダサイズ計算・表示機能
- [ ] 更新日時表示（ファイル詳細情報）

### パフォーマンス
- [ ] 大きなディレクトリの仮想スクロール
- [ ] ファイルプレビューのキャッシュ
- [ ] Worker使用での非同期処理

## 参考実装
- Ruby版: `./reference/` - オリジナル実装
- 特に `window.rb` のキーバインド定義を参考

## 別アプリ候補機能

以下の機能は高度すぎるため、専用アプリでの実装が適している：

### テキスト処理系
- **diff機能**: 2ファイル間の差分表示、マージ機能
  - 専用diffツール（VS Code、WinMerge、Beyond Compare等）が適している
- **文字コード変換機能**: ファイルの文字エンコーディング変換・保存
  - 専用変換ツールまたはエディタ機能として実装が適している

### 設計思想
Mireruは「気軽に使えるexplorer」として、ファイル閲覧・プレビューに特化。
高度な編集・変換機能は専用ツールに委ねることで、軽量性と使いやすさを維持。

---

*最終更新: 2025/06/03*